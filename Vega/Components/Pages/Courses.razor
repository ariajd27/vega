@page "/courses/{QuerySubject}"
@attribute [StreamRendering]
@rendermode InteractiveServer

<PageTitle>Courses</PageTitle>

<div class="page_body_field">

    <h1>Courses</h1>

    <p>Here is a list of all @QuerySubject courses:</p>

</div>

@if (courses == null)
{
    <p><em>Loading...</em></p>
}
else
{
    @foreach (var course in courses)
    {
        <CollapsibleHeader>
            <HeaderContent>
                @course.FormattedCatalogNumber() @course.Title
            </HeaderContent>
            <ChildContent>
                <p>@course.Description</p>
                <p>typically offered: @course.TypicalTerms</p>
                <p>credits: @course.FormattedNumCredits()</p>
                <p>internal id: @course.InternalId</p>
            </ChildContent>
        </CollapsibleHeader>
    }
}

@code {
    [Parameter]
    public string? QuerySubject { get; set; }

    [SupplyParameterFromQuery(Name = "campus")]
    public string? QueryCampus { get; set; }
    [SupplyParameterFromQuery(Name = "terms")]
    public string? QueryTerms { get; set; }
    [SupplyParameterFromQuery(Name = "minCredits")]
    public string? QueryMinCredits { get; set; }
    [SupplyParameterFromQuery(Name = "maxCredits")]
    public string? QueryMaxCredits { get; set; }

    private Course[]? courses;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadCampusAsync();
            await LoadCoursesAsync();
            StateHasChanged();
        }
    }

    private async Task LoadCampusAsync()
    {
        var result = await ProtectedSessionStore.GetAsync<string>("campus");
    }

    private async Task LoadCoursesAsync()
    {
        Course[]? unfilteredCourses;
        var result = await ProtectedSessionStore.GetAsync<Course[]>($"courses-{QuerySubject}");
        if (result.Success) unfilteredCourses = result.Value;
        else
        {
            unfilteredCourses = (await Course.GetAllCoursesAsync(QuerySubject));
            await ProtectedSessionStore.SetAsync($"courses-{QuerySubject}", unfilteredCourses);
        }

        courses = unfilteredCourses.Where(x => QueryCampus == null || x.Campus == QueryCampus)
                                   .Where(x => QueryTerms == null || ((int)x.TypicalTerms & int.Parse(QueryTerms)) > 0)
                                   .Where(x => QueryMinCredits == null || x.MaxNumCredits >= int.Parse(QueryMinCredits))
                                   .Where(x => QueryMaxCredits == null || x.MinNumCredits <= int.Parse(QueryMaxCredits))
                                   .ToArray();
    }
}
